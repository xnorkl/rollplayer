# Fly.io configuration for GM Chatbot
# See https://fly.io/docs/reference/configuration/ for full documentation

app = "roll20-chatbot"
primary_region = "iad" # Change to your preferred region

[build]
# Dockerfile is in infrastructure/ directory
# Build context is project root (where fly.toml must be located for deployment)
# Copy this file to project root before deploying: cp infrastructure/fly.toml fly.toml
dockerfile = "infrastructure/Dockerfile"

[env]
WS_ADDRESS = "0.0.0.0"
LOG_LEVEL = "INFO"

# Note: Using TCP service configuration for WebSocket-only service
# HTTP service removed to prevent connection resets from HTTP health checks
# TCP health checks are more appropriate for WebSocket services

[processes]
app = "python3 chat_bot.py"

[[services]]
internal_port = 5678
protocol = "tcp"
processes = ["app"]

[[services.ports]]
port = 443
handlers = ["tls", "http"]
force_https = true

[[services.ports]]
port = 80
handlers = ["http"]
force_https = true

[[services.tcp_checks]]
grace_period = "10s"
interval = "30s"
timeout = "5s"

[vm]
cpu_kind = "shared"
cpus = 1
memory_mb = 256
