name: Deploy to Fly.io

on:
  workflow_run:
    workflows:
      - "Integration Tests"
    types:
      - completed
    branches:
      - main
      - master
jobs:
  check-and-deploy:
    name: Verify Tests and Deploy
    runs-on: ubuntu-latest
    # Proceed with deployment iff tests passed
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Verify Integration Tests Passed
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "::error::Integration test workflow failed. Deployment cancelled."
            exit 1
          fi
          echo "✓ Integration tests passed"
          echo "✓ Unit tests passed (verified by integration workflow)"
          echo "Proceeding with deployment."
  build:
    name: Build and Validate
    runs-on: ubuntu-latest
    needs: check-and-deploy
    outputs:
      app_name: ${{ steps.get-app-name.outputs.app_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Install uv
        uses: astral-sh/setup-uv@v1

      - name: Set up Python
        run: uv python install 3.12

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock*') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: uv sync --no-dev --no-install-project

      - name: Run smoke tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          uv run python smoke_test.py || echo "Smoke tests failed but continuing deployment"

      - name: Get app name
        id: get-app-name
        run: |
          APP_NAME=$(grep '^app =' infrastructure/fly.toml | cut -d'"' -f2)
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Verify Fly.io authentication
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          if [ -z "$FLY_API_TOKEN" ]; then
            echo "::error::FLY_API_TOKEN secret is not set. Please configure it in GitHub repository settings."
            exit 1
          fi
          echo "FLY_API_TOKEN is set."

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Ensure Fly.io app exists
        id: ensure-app
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          APP_NAME=$(grep '^app =' infrastructure/fly.toml | cut -d'"' -f2)
          if ! flyctl apps list --json | jq -e ".[] | select(.Name == \"$APP_NAME\")" > /dev/null 2>&1; then
            echo "App '$APP_NAME' does not exist, creating..."
            flyctl apps create "$APP_NAME" || echo "App creation failed or already exists"
          else
            echo "App '$APP_NAME' already exists"
          fi

      - name: Ensure Fly.io volumes exist
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          chmod +x infrastructure/manage-volumes.sh
          ./infrastructure/manage-volumes.sh ensure
        continue-on-error: false

      - name: Prepare deployment
        run: |
          # Copy fly.toml to project root (required for flyctl deploy)
          cp infrastructure/fly.toml fly.toml

      - name: Deploy to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --remote-only
        continue-on-error: false

      - name: Verify deployment
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          APP_NAME=$(grep '^app =' infrastructure/fly.toml | cut -d'"' -f2)
          flyctl status --app "$APP_NAME" || echo "Status check failed"

      - name: Deployment notification
        if: success()
        run: |
          APP_NAME=$(grep '^app =' infrastructure/fly.toml | cut -d'"' -f2)
          echo "[+] Deployment successful!"
          echo "App URL: https://${APP_NAME}.fly.dev"

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "[-] Deployment failed!"
          exit 1
